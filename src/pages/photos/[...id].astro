---
import { getCollection, type CollectionEntry } from "astro:content";
import GalleryLayout from "@layouts/GalleryLayout.astro";
import PhotoSwipeGallery from "@components/PhotoSwipeGallery.astro";
import { getGalleryImages } from "@utils/gallery";
import { isPublished } from "@utils/content";

type Gallery = CollectionEntry<"galleries">;

type Props = {
  gallery: Gallery;
};

// Generate a new path for every collection entry
export async function getStaticPaths() {
  // Get published (non-draft) galleries in production
  const galleries = await getCollection("galleries", isPublished);

  return galleries.map((gallery: Gallery) => ({
    params: { id: gallery.id },
    props: { gallery },
  }));
}

// Get the gallery entry directly from the prop
const { gallery } = Astro.props;

// Build title with draft indicator
const title = gallery.data.title + (gallery.data.isDraft ? " (draft)" : "");

// Get gallery images using utility function
const galleryImages = await getGalleryImages(
  gallery.id,
  gallery.data.photos
);
---

<GalleryLayout
  title={title}
  subtitle={gallery.data.description}
>
  {galleryImages.length > 0 ? (
    <PhotoSwipeGallery
      images={galleryImages}
      galleryId={gallery.id}
    />
  ) : (
    <p>No images found in this gallery.</p>
  )}
</GalleryLayout>
