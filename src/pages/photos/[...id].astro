---
import { getCollection, type CollectionEntry } from "astro:content";
import Layout from "@layouts/Layout.astro";
import Header from "@components/Header.astro";
import ProseWrapper from "@components/ProseWrapper.astro";
import PhotoSwipeGallery from "@components/PhotoSwipeGallery.astro";

export async function getStaticPaths() {
  // Get published (non-draft) galleries in production
  const galleries = await getCollection("galleries", ({ data }) => {
    return import.meta.env.PROD ? data.isDraft !== true : true;
  });

  return galleries.map((gallery) => ({
    params: { id: gallery.id },
    props: { gallery },
  }));
}

interface Props {
  gallery: CollectionEntry<"galleries">;
}

const { gallery } = Astro.props;

// Build title with draft indicator
const title = gallery.data.title + (gallery.data.isDraft ? " (draft)" : "");

// Glob all images from gallery directory
const allImages = import.meta.glob<{ default: ImageMetadata }>(
  "@assets/gallery/**/*.{jpg,jpeg,png,JPG,JPEG,PNG}",
  { eager: true }
);

// Filter images that belong to this specific gallery and create lookup by filename
const galleryImageEntries = Object.entries(allImages)
  .filter(([path]) => path.includes(`/gallery/${gallery.id}/`))
  .filter(([path]) => !path.endsWith('gallery.yaml'));

// Determine gallery images based on whether photos list exists
let galleryImages: {
  src: ImageMetadata;
  alt: string;
  title?: string;
}[];

if (gallery.data.photos && gallery.data.photos.length > 0) {
  // Use specified photos list for ordering and filtering
  const imagesByFilename = new Map(
    galleryImageEntries.map(([path, module]) => [
      path.split('/').pop() || '',
      { path, module }
    ])
  );

  galleryImages = gallery.data.photos
    .map(filename => {
      const entry = imagesByFilename.get(filename);
      if (!entry) return null;
      return {
        src: entry.module.default,
        alt: filename.replace(/\.[^/.]+$/, ''),
      };
    })
    .filter((img): img is { src: ImageMetadata; alt: string } => img !== null);
} else {
  // Default behavior: all images sorted alphabetically by filename
  galleryImages = galleryImageEntries
    .map(([path, module]) => ({
      src: module.default,
      alt: path.split('/').pop()?.replace(/\.[^/.]+$/, '') || 'Gallery image',
    }))
    .sort((a, b) => a.alt.localeCompare(b.alt));
}
---

<Layout title={title}>
  <Header
    title={title}
    subtitle={gallery.data.description}
    slot="header"
  />

  <ProseWrapper>
    {galleryImages.length > 0 ? (
      <>
        <PhotoSwipeGallery
          images={galleryImages}
          galleryId={gallery.id}
          columns={3}
        />
      </>
    ) : (
      <p>No images found in this gallery.</p>
    )}
  </ProseWrapper>
</Layout>

<script>
  import PhotoSwipeLightbox from 'photoswipe/lightbox';
  import PhotoSwipe from 'photoswipe';

  // Initialize PhotoSwipe for all galleries on the page
  document.addEventListener('DOMContentLoaded', () => {
    const galleries = document.querySelectorAll('[data-pswp-gallery]');

    galleries.forEach((galleryEl) => {
      const galleryId = galleryEl.getAttribute('data-pswp-gallery');

      const lightbox = new PhotoSwipeLightbox({
        gallery: `[data-pswp-gallery="${galleryId}"]`,
        children: 'a',
        pswpModule: PhotoSwipe,
        showHideAnimationType: 'fade',
        initialZoomLevel: 'fit',
        secondaryZoomLevel: 1,
        maxZoomLevel: 1,
        zoom: false,
        clickToCloseNonZoomable: false,
      });

      // Add caption support
      lightbox.on('uiRegister', function() {
        if (!lightbox.pswp || !lightbox.pswp.ui) return;

        lightbox.pswp.ui.registerElement({
          name: 'caption',
          order: 9,
          isButton: false,
          appendTo: 'root',
          html: '',
          onInit: (el) => {
            if (!lightbox.pswp) return;

            lightbox.pswp.on('change', () => {
              if (!lightbox.pswp || !lightbox.pswp.currSlide) return;

              const currSlideElement = lightbox.pswp.currSlide.data.element;
              let captionHTML = '';

              if (currSlideElement) {
                const hiddenCaption = currSlideElement.querySelector('.hidden-caption');
                if (hiddenCaption) {
                  captionHTML = hiddenCaption.innerHTML;
                }
                // No fallback to alt text - only show captions when explicitly provided
              }

              el.innerHTML = captionHTML || '';
            });
          }
        });
      });

      lightbox.init();
    });
  });
</script>
