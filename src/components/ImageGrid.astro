---
import { Image } from "astro:assets";
import BaseFigure from "@components/BaseFigure.astro";

interface Props {
  columns: number;
  layout?: "normal" | "full" | "fullscreen";
  aspectRatio?: string | number;
  images: {
    src: ImageMetadata;
    alt: string;
    xoff?: number;
    yoff?: number;
  }[];
}

const { columns = 3, layout = "normal", aspectRatio, images } = Astro.props;
const cssAspectRatio = aspectRatio?.toString().replace("/", " / ");

/**
 * Responsive breakpoint thresholds (in pixels)
 */
const BREAKPOINTS = {
  mobile: 500,
  tablet: 800,
  desktop: 1400,
} as const;

/**
 * Image widths for optimization at each layout type
 */
const IMAGE_WIDTHS = {
  normal: [500, 800],
  full: [500, 800, 1220],
  fullscreen: [500, 800, 1600],
};

/**
 * Default widths for each layout type (largest responsive size)
 */
const DEFAULT_WIDTHS = {
  normal: 800,
  full: 1220,
  fullscreen: 1600,
} as const;

/**
 * Clamps offset values and computes CSS object-position
 * @param xoff - Horizontal offset (-50 to 50)
 * @param yoff - Vertical offset (-50 to 50)
 * @returns CSS object-position value
 */
const computePosition = (xoff = 0, yoff = 0) => {
  const x = 50 - Math.max(-50, Math.min(50, xoff));
  const y = 50 - Math.max(-50, Math.min(50, yoff));
  return `${x}% ${y}%`;
};

/**
 * Generates responsive sizes attribute based on layout type
 * @param src - Image metadata
 * @param layoutWidth - Layout type (normal/full/fullscreen)
 * @returns Sizes attribute string for responsive images
 */
const getImageSizes = (src: ImageMetadata, layoutWidth: typeof layout) => {
  switch (layoutWidth) {
    case "normal":
      return `(max-width: ${BREAKPOINTS.mobile}px) ${BREAKPOINTS.mobile}px, (max-width: ${BREAKPOINTS.tablet}px) ${BREAKPOINTS.tablet}px, ${DEFAULT_WIDTHS.normal}px`;
    case "full":
      return `(max-width: ${BREAKPOINTS.mobile}px) ${BREAKPOINTS.mobile}px, (max-width: ${BREAKPOINTS.tablet}px) ${BREAKPOINTS.tablet}px, ${DEFAULT_WIDTHS.full}px`;
    case "fullscreen":
      return `(max-width: ${BREAKPOINTS.mobile}px) ${BREAKPOINTS.mobile}px, (max-width: ${BREAKPOINTS.tablet}px) ${BREAKPOINTS.tablet}px, (max-width: ${BREAKPOINTS.desktop}px) ${DEFAULT_WIDTHS.fullscreen}px, ${src.width}px`;
    default:
      return `${DEFAULT_WIDTHS.normal}px`;
  }
};

/**
 * Returns array of widths for image optimization based on layout type
 * @param src - Image metadata
 * @param layoutWidth - Layout type (normal/full/fullscreen)
 * @returns Array of pixel widths for srcset generation
 */
const getImageWidths = (src: ImageMetadata, layoutWidth: typeof layout) => {
  switch (layoutWidth) {
    case "normal":
      return IMAGE_WIDTHS.normal;
    case "full":
      return IMAGE_WIDTHS.full;
    case "fullscreen":
      return [...IMAGE_WIDTHS.fullscreen, src.width];
    default:
      return [DEFAULT_WIDTHS.normal];
  }
};
---

<BaseFigure layout={layout} className="ImageGrid">
  <div class="ImageGrid-grid">
    {
      images.map(({ src, alt, xoff, yoff }) => (
        <Image
          src={src}
          alt={alt}
          style={{ objectPosition: computePosition(xoff, yoff) }}
          sizes={getImageSizes(src, layout)}
          widths={getImageWidths(src, layout)}
        />
      ))
    }
  </div>
  {layout === "normal" && <slot name="sidenote" />}
  <slot name="figcaption" />
</BaseFigure>

<style define:vars={{ columns, cssAspectRatio }}>
  /* Root variables */
  :root {
    --image-grid-gap: 0.5rem;
  }

  /* Grid container */
  .ImageGrid-grid {
    display: grid;
    grid-template-columns: repeat(var(--columns), 1fr);
    gap: var(--image-grid-gap);
    width: 100%;
    float: left;
  }

  /* Image styles */
  :global(.ImageGrid-grid > img),
  :global(.ImageGrid-grid > :is(astro-island, *) > img) {
    width: 100%;
    height: 100%;
    object-fit: cover;
    aspect-ratio: var(--cssAspectRatio, auto);
  }
</style>
